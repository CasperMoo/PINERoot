generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  relationMode = "prisma"
}

enum UserRole {
  USER  // 普通用户
  ADMIN // 管理员
}

enum Frequency {
  ONCE         // 单次提醒
  DAILY        // 每天
  EVERY_X_DAYS // 每隔 x 天
  WEEKLY       // 每周某天
  MONTHLY      // 每月某天
  YEARLY       // 每年某天
}

enum ReminderStatus {
  PENDING   // 等待触发或待操作
  COMPLETED // 用户已确认完成
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  nickname  String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  vocabularies UserVocabulary[]
  chatSessions ChatSession[]
}

model Image {
  id           Int       @id @default(autoincrement())
  userId       Int       // 上传者ID
  originalName String    // 原始文件名
  ossKey       String    @unique // OSS存储路径/key
  ossUrl       String    // OSS公开访问URL
  mimeType     String    // 文件类型 (image/jpeg, image/png等)
  size         Int       // 文件大小(bytes)
  width        Int?      // 图片宽度(可选)
  height       Int?      // 图片高度(可选)
  tagId        Int       @default(1) // 标签ID（关联 ImageTag，默认为1）
  deletedAt    DateTime? // 软删除时间
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([tagId])
  @@index([deletedAt])
}

model ImageTag {
  id        Int       @id @default(autoincrement())
  name      String    @unique // 标签名
  deletedAt DateTime? // 软删除时间
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model ActivityConfig {
  id         Int       @id @default(autoincrement())
  activityId String    // 活动英文ID（可重复，用于版本管理）
  config     Json      // JSON配置数据
  version    Int       // 版本号（同一个activityId下递增）
  deletedAt  DateTime? // 软删除（旧版本标记为删除，最新版本为NULL）
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([activityId, version]) // activityId + version 唯一
  @@index([activityId, deletedAt]) // 查询当前生效版本的索引
  @@index([deletedAt])
}

model Reminder {
  id                Int             @id @default(autoincrement())
  userId            Int             // 用户ID
  title             String          @db.VarChar(255) // 提醒标题
  description       String?         @db.Text // 提醒描述（可选）
  frequency         Frequency       // 触发频率
  interval          Int?            // 循环间隔（用于 EVERY_X_DAYS）
  weekDays          String?         @db.VarChar(100) // 每周哪些天触发（用于 WEEKLY），JSON 数组字符串
  dayOfMonth        Int?            // 每月哪一天触发（用于 MONTHLY，1-31）
  startDate         DateTime?       @db.Date // 循环模式起始日期
  lastCompletedDate DateTime?       @db.Date // 上次完成日期
  nextTriggerDate   DateTime        @db.Date // 下一次触发日期
  status            ReminderStatus  @default(PENDING) // 当前状态
  deletedAt         DateTime?       // 软删除标志
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([userId, deletedAt])
  @@index([nextTriggerDate, deletedAt])
}

model AiWorkflowLog {
  id             Int      @id @default(autoincrement())

  // 工作流标识
  workflowName   String   // 对应配置文件中的 key（如 "translation"）
  provider       String   // 提供商类型（如 "coze"）

  // 请求信息
  requestParams  Json     // 请求参数（存储用户输入）

  // 响应信息
  responseStatus String   // success | error | interrupted | timeout

  // Token 统计
  tokenInput     Int?     // 输入 Token 数
  tokenOutput    Int?     // 输出 Token 数
  tokenTotal     Int?     // 总 Token 数

  // 错误信息
  errorCode      Int?     // 错误码
  errorMessage   String?  @db.Text  // 错误详情

  // 性能指标
  durationMs     Int      // 响应耗时（毫秒）

  // 时间戳
  createdAt      DateTime @default(now())

  @@index([workflowName, createdAt])
  @@index([responseStatus])
  @@index([createdAt])
  @@map("ai_workflow_logs")
}

// 单词本相关枚举
enum Language {
  CHINESE
  JAPANESE
}

enum VocabularyStatus {
  NEW        // 新学习
  LEARNING   // 学习中
  MASTERED   // 已掌握
}

// 词库总表（全局缓存）
model WordLibrary {
  id              Int      @id @default(autoincrement())

  // 原文（唯一键，用于缓存查询）
  originalText    String   @unique @db.VarChar(500)

  // 语言类型
  language        Language // 'CHINESE' | 'JAPANESE'

  // 翻译结果（完整的 JSON 数据）
  translationData Json     // 存储 AI 返回的完整结构

  // 统计信息
  queryCount      Int      @default(1)  // 查询次数（热度统计）

  // 时间戳
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 关联关系
  userVocabularies UserVocabulary[]

  @@index([language])
  @@index([queryCount])  // 用于"热门单词"查询
  @@index([createdAt])
  @@map("word_library")
}

// 用户单词本关联表
model UserVocabulary {
  id        Int      @id @default(autoincrement())

  // 关联用户
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 关联单词
  wordId    Int
  word      WordLibrary @relation(fields: [wordId], references: [id], onDelete: Cascade)

  // 用户选择的翻译索引（支持单个翻译收藏）
  selectedIndex Int   @default(0)  // 对应 translationData 数组的索引

  // 用户自定义笔记
  note      String?  @db.Text

  // 学习状态（可选，未来扩展）
  status    VocabularyStatus @default(NEW)

  // 时间戳
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, wordId])  // 防止重复收藏
  @@index([userId, createdAt])
  @@index([userId, status])   // 按状态筛选
  @@map("user_vocabulary")
}

// ==================== Chat Companion ====================

// 人设模板
model PersonaTemplate {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(100)
  description String?       @db.VarChar(500)
  prompt      String        @db.Text
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  sessions    ChatSession[]
}

// 聊天会话
model ChatSession {
  id          Int               @id @default(autoincrement())
  userId      Int
  personaId   Int?
  modelId     String?           @db.VarChar(100)
  mem0Id      String            @unique @db.VarChar(100)
  isActive    Boolean           @default(true)
  clearedAt   DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  user        User              @relation(fields: [userId], references: [id])
  persona     PersonaTemplate?  @relation(fields: [personaId], references: [id])
  messages    ChatMessage[]

  @@index([userId, isActive])
}

// 聊天消息
model ChatMessage {
  id          Int         @id @default(autoincrement())
  sessionId   Int
  role        String      @db.VarChar(20)
  content     String      @db.Text
  modelId     String?     @db.VarChar(100)
  createdAt   DateTime    @default(now())

  session     ChatSession @relation(fields: [sessionId], references: [id])

  @@index([sessionId, createdAt])
}
