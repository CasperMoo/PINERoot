generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  relationMode = "prisma"
}

enum UserRole {
  USER  // 普通用户
  ADMIN // 管理员
}

enum Frequency {
  ONCE         // 单次提醒
  DAILY        // 每天
  EVERY_X_DAYS // 每隔 x 天
  WEEKLY       // 每周某天
  MONTHLY      // 每月某天
  YEARLY       // 每年某天
}

enum ReminderStatus {
  PENDING   // 等待触发或待操作
  COMPLETED // 用户已确认完成
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  nickname  String?
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Image {
  id           Int       @id @default(autoincrement())
  userId       Int       // 上传者ID
  originalName String    // 原始文件名
  ossKey       String    @unique // OSS存储路径/key
  ossUrl       String    // OSS公开访问URL
  mimeType     String    // 文件类型 (image/jpeg, image/png等)
  size         Int       // 文件大小(bytes)
  width        Int?      // 图片宽度(可选)
  height       Int?      // 图片高度(可选)
  tagId        Int       @default(1) // 标签ID（关联 ImageTag，默认为1）
  deletedAt    DateTime? // 软删除时间
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([tagId])
  @@index([deletedAt])
}

model ImageTag {
  id        Int       @id @default(autoincrement())
  name      String    @unique // 标签名
  deletedAt DateTime? // 软删除时间
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model ActivityConfig {
  id         Int       @id @default(autoincrement())
  activityId String    // 活动英文ID（可重复，用于版本管理）
  config     Json      // JSON配置数据
  version    Int       // 版本号（同一个activityId下递增）
  deletedAt  DateTime? // 软删除（旧版本标记为删除，最新版本为NULL）
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([activityId, version]) // activityId + version 唯一
  @@index([activityId, deletedAt]) // 查询当前生效版本的索引
  @@index([deletedAt])
}

model Reminder {
  id                Int             @id @default(autoincrement())
  userId            Int             // 用户ID
  title             String          @db.VarChar(255) // 提醒标题
  description       String?         @db.Text // 提醒描述（可选）
  frequency         Frequency       // 触发频率
  interval          Int?            // 循环间隔（用于 EVERY_X_DAYS）
  weekDays          String?         @db.VarChar(100) // 每周哪些天触发（用于 WEEKLY），JSON 数组字符串
  dayOfMonth        Int?            // 每月哪一天触发（用于 MONTHLY，1-31）
  startDate         DateTime?       @db.Date // 循环模式起始日期
  lastCompletedDate DateTime?       @db.Date // 上次完成日期
  nextTriggerDate   DateTime        @db.Date // 下一次触发日期
  status            ReminderStatus  @default(PENDING) // 当前状态
  deletedAt         DateTime?       // 软删除标志
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([userId, deletedAt])
  @@index([nextTriggerDate, deletedAt])
}
